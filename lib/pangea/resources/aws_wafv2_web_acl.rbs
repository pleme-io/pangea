# RBS type definitions for AWS WAF v2 Web ACL resource

module Pangea
  module Resources
    module AWS
      module Types
        type wafv2_scope = "REGIONAL" | "CLOUDFRONT"
        type wafv2_default_action_type = "ALLOW" | "BLOCK"  
        type wafv2_rule_action_type = "ALLOW" | "BLOCK" | "COUNT" | "CAPTCHA" | "CHALLENGE"
        type wafv2_positional_constraint = "EXACTLY" | "STARTS_WITH" | "ENDS_WITH" | "CONTAINS" | "CONTAINS_WORD"
        type wafv2_comparison_operator = "EQ" | "NE" | "LE" | "LT" | "GE" | "GT"
        type wafv2_text_transformation = "NONE" | "COMPRESS_WHITE_SPACE" | "HTML_ENTITY_DECODE" | "LOWERCASE" | "CMD_LINE" | "URL_DECODE" | "BASE64_DECODE" | "HEX_DECODE" | "MD5" | "REPLACE_COMMENTS" | "ESCAPE_SEQ_DECODE" | "SQL_HEX_DECODE" | "CSS_DECODE" | "JS_DECODE" | "NORMALIZE_PATH" | "NORMALIZE_PATH_WIN" | "REMOVE_NULLS" | "REPLACE_NULLS" | "BASE64_DECODE_EXT" | "URL_DECODE_UNI" | "UTF8_TO_UNICODE"
        type wafv2_oversize_handling = "CONTINUE" | "MATCH" | "NO_MATCH"
        type wafv2_fallback_behavior = "MATCH" | "NO_MATCH"
        type wafv2_aggregate_key_type = "IP" | "FORWARDED_IP"
        type wafv2_json_match_scope = "ALL" | "KEY" | "VALUE"
        type wafv2_invalid_fallback_behavior = "MATCH" | "NO_MATCH" | "EVALUATE_AS_STRING"
        type wafv2_content_type = "TEXT_PLAIN" | "TEXT_HTML" | "APPLICATION_JSON"
        
        interface _WafV2VisibilityConfig
          def cloudwatch_metrics_enabled: () -> bool
          def metric_name: () -> String
          def sampled_requests_enabled: () -> bool
        end
        
        interface _WafV2FieldToMatch
          def all_query_arguments?: () -> Hash[Symbol, untyped]?
          def body?: () -> {
            oversize_handling?: wafv2_oversize_handling?
          }?
          def method?: () -> Hash[Symbol, untyped]?
          def query_string?: () -> Hash[Symbol, untyped]?
          def single_header?: () -> { name: String }?
          def single_query_argument?: () -> { name: String }?
          def uri_path?: () -> Hash[Symbol, untyped]?
          def json_body?: () -> {
            match_pattern: {
              all?: Hash[Symbol, untyped]?,
              included_paths?: Array[String]?
            },
            match_scope: wafv2_json_match_scope,
            invalid_fallback_behavior?: wafv2_invalid_fallback_behavior?,
            oversize_handling?: wafv2_oversize_handling?
          }?
        end

        interface _WafV2TextTransformation
          def priority: () -> Integer
          def type: () -> wafv2_text_transformation
        end

        interface _WafV2Statement
          def byte_match_statement?: () -> {
            field_to_match: _WafV2FieldToMatch,
            positional_constraint: wafv2_positional_constraint,
            search_string: String,
            text_transformations: Array[_WafV2TextTransformation]
          }?
          def sqli_match_statement?: () -> {
            field_to_match: _WafV2FieldToMatch,
            text_transformations: Array[_WafV2TextTransformation]
          }?
          def xss_match_statement?: () -> {
            field_to_match: _WafV2FieldToMatch,
            text_transformations: Array[_WafV2TextTransformation]
          }?
          def size_constraint_statement?: () -> {
            field_to_match: _WafV2FieldToMatch,
            comparison_operator: wafv2_comparison_operator,
            size: Integer,
            text_transformations: Array[_WafV2TextTransformation]
          }?
          def geo_match_statement?: () -> {
            country_codes: Array[String],
            forwarded_ip_config?: {
              header_name: String,
              fallback_behavior: wafv2_fallback_behavior
            }?
          }?
          def ip_set_reference_statement?: () -> {
            arn: String,
            ip_set_forwarded_ip_config?: {
              header_name: String,
              fallback_behavior: wafv2_fallback_behavior,
              position: String
            }?
          }?
          def rule_group_reference_statement?: () -> {
            arn: String,
            excluded_rules?: Array[{ name: String }]?
          }?
          def managed_rule_group_statement?: () -> {
            vendor_name: String,
            name: String,
            version?: String?,
            excluded_rules?: Array[{ name: String }]?,
            scope_down_statement?: Hash[Symbol, untyped]?,
            managed_rule_group_configs?: Array[Hash[Symbol, untyped]]?
          }?
          def rate_based_statement?: () -> {
            limit: Integer,
            aggregate_key_type: wafv2_aggregate_key_type,
            forwarded_ip_config?: {
              header_name: String,
              fallback_behavior: wafv2_fallback_behavior
            }?,
            scope_down_statement?: Hash[Symbol, untyped]?
          }?
          def and_statement?: () -> {
            statements: Array[Hash[Symbol, untyped]]
          }?
          def or_statement?: () -> {
            statements: Array[Hash[Symbol, untyped]]
          }?
          def not_statement?: () -> {
            statement: Hash[Symbol, untyped]
          }?
        end

        interface _WafV2CustomRequestHandling
          def insert_headers: () -> Array[{ name: String, value: String }]
        end

        interface _WafV2CustomResponse
          def response_code: () -> Integer
          def custom_response_body_key?: () -> String?
          def response_headers?: () -> Array[{ name: String, value: String }]?
        end

        interface _WafV2RuleAction
          def allow?: () -> {
            custom_request_handling?: _WafV2CustomRequestHandling?
          }?
          def block?: () -> {
            custom_response?: _WafV2CustomResponse?
          }?
          def count?: () -> {
            custom_request_handling?: _WafV2CustomRequestHandling?
          }?
          def captcha?: () -> {
            custom_request_handling?: _WafV2CustomRequestHandling?
          }?
          def challenge?: () -> {
            custom_request_handling?: _WafV2CustomRequestHandling?
          }?
        end

        interface _WafV2DefaultAction
          def allow?: () -> {
            custom_request_handling?: _WafV2CustomRequestHandling?
          }?
          def block?: () -> {
            custom_response?: _WafV2CustomResponse?
          }?
        end

        interface _WafV2ImmunityTimeProperty
          def immunity_time: () -> Integer
        end

        interface _WafV2Rule
          def name: () -> String
          def priority: () -> Integer
          def action: () -> _WafV2RuleAction
          def statement: () -> _WafV2Statement
          def visibility_config: () -> _WafV2VisibilityConfig
          def rule_labels?: () -> Array[{ name: String }]
          def captcha_config?: () -> {
            immunity_time_property: _WafV2ImmunityTimeProperty
          }?
          def challenge_config?: () -> {
            immunity_time_property: _WafV2ImmunityTimeProperty
          }?
        end

        class WafV2VisibilityConfig < Dry::Struct
          def self.new: (Hash[Symbol, untyped] attributes) -> instance

          def cloudwatch_metrics_enabled: () -> bool
          def metric_name: () -> String  
          def sampled_requests_enabled: () -> bool
        end

        class WafV2Statement < Dry::Struct
          def self.new: (Hash[Symbol, untyped] attributes) -> instance
        end

        class WafV2RuleAction < Dry::Struct
          def self.new: (Hash[Symbol, untyped] attributes) -> instance
        end

        class WafV2Rule < Dry::Struct
          def self.new: (Hash[Symbol, untyped] attributes) -> instance
        end

        class WafV2DefaultAction < Dry::Struct
          def self.new: (Hash[Symbol, untyped] attributes) -> instance
        end

        class WafV2WebAclAttributes < Dry::Struct
          def self.new: (Hash[Symbol, untyped] attributes) -> instance

          def name: () -> String
          def scope: () -> String
          def default_action: () -> WafV2DefaultAction
          def description?: () -> String?
          def rules: () -> Array[WafV2Rule]
          def visibility_config: () -> WafV2VisibilityConfig
          def tags: () -> Hash[Symbol, String]
          def custom_response_bodies: () -> Hash[String, { content: String, content_type: wafv2_content_type }]
          def token_domains: () -> Array[String]
          def challenge_config?: () -> { immunity_time_property: _WafV2ImmunityTimeProperty }?
          def captcha_config?: () -> { immunity_time_property: _WafV2ImmunityTimeProperty }?

          def total_capacity_units_estimate: () -> Integer
          def has_rate_limiting?: () -> bool
          def has_geo_blocking?: () -> bool
          def has_managed_rules?: () -> bool
          def uses_custom_responses?: () -> bool
        end
      end

      # Create an AWS WAF v2 Web ACL
      def aws_wafv2_web_acl: (
        Symbol name,
        ?name: String,
        ?scope: Types::wafv2_scope,
        ?default_action: {
          allow?: {
            custom_request_handling?: {
              insert_headers: Array[{ name: String, value: String }]
            }
          },
          block?: {
            custom_response?: {
              response_code: Integer,
              custom_response_body_key?: String,
              response_headers?: Array[{ name: String, value: String }]
            }
          }
        },
        ?description: String,
        ?rules: Array[{
          name: String,
          priority: Integer,
          action: {
            allow?: {
              custom_request_handling?: {
                insert_headers: Array[{ name: String, value: String }]
              }
            },
            block?: {
              custom_response?: {
                response_code: Integer,
                custom_response_body_key?: String,
                response_headers?: Array[{ name: String, value: String }]
              }
            },
            count?: {
              custom_request_handling?: {
                insert_headers: Array[{ name: String, value: String }]
              }
            },
            captcha?: {
              custom_request_handling?: {
                insert_headers: Array[{ name: String, value: String }]
              }
            },
            challenge?: {
              custom_request_handling?: {
                insert_headers: Array[{ name: String, value: String }]
              }
            }
          },
          statement: Hash[Symbol, untyped],
          visibility_config: {
            cloudwatch_metrics_enabled: bool,
            metric_name: String,
            sampled_requests_enabled: bool
          },
          rule_labels?: Array[{ name: String }],
          captcha_config?: {
            immunity_time_property: { immunity_time: Integer }
          },
          challenge_config?: {
            immunity_time_property: { immunity_time: Integer }
          }
        }],
        ?visibility_config: {
          cloudwatch_metrics_enabled: bool,
          metric_name: String,
          sampled_requests_enabled: bool
        },
        ?tags: Hash[Symbol, String],
        ?custom_response_bodies: Hash[String, {
          content: String,
          content_type: Types::wafv2_content_type
        }],
        ?token_domains: Array[String],
        ?challenge_config: {
          immunity_time_property: { immunity_time: Integer }
        },
        ?captcha_config: {
          immunity_time_property: { immunity_time: Integer }
        }
      ) -> ResourceReference
    end
  end
end